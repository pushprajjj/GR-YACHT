<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yacht Bookings - GR Yachts Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="admin-styles.css">
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <img src="../assets/images/logoColoured.png" alt="GR Yachts" class="sidebar-logo">
            <h3 class="sidebar-title">GR YACHTS</h3>
            <p class="sidebar-subtitle">Admin Dashboard</p>
        </div>
        
        <nav class="sidebar-nav">
            <div class="nav-item">
                <a href="dashboard.html" class="nav-link">
                    <i class="fas fa-tachometer-alt"></i>
                    Dashboard
                </a>
            </div>
            <div class="nav-item">
                <a href="contacts.html" class="nav-link">
                    <i class="fas fa-envelope"></i>
                    Contact Messages
                    <span class="nav-badge" id="contactsBadge">0</span>
                </a>
            </div>
            <div class="nav-item">
                <a href="bookings.html" class="nav-link active">
                    <i class="fas fa-anchor"></i>
                    Yacht Bookings
                    <span class="nav-badge" id="bookingsBadge">0</span>
                </a>
            </div>
            <div class="nav-item">
                <a href="yacht-fleet.html" class="nav-link">
                    <i class="fas fa-ship"></i>
                    Yacht Fleet
                </a>
            </div>
            <div class="nav-item">
                <a href="manage-site.html" class="nav-link">
                    <i class="fas fa-edit"></i>
                    Manage Site
                </a>
            </div>
            <div class="nav-item">
                <a href="settings.html" class="nav-link">
                    <i class="fas fa-cog"></i>
                    Settings
                </a>
            </div>
            <div class="nav-item">
                <a href="#" class="nav-link" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                    Logout
                </a>
            </div>
        </nav>
    </div>

    <!-- Sidebar Overlay for Mobile -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- Main Content -->
    <div class="main-content" id="mainContent">
        <!-- Top Navbar -->
        <div class="top-navbar">
            <div class="navbar-left">
                <button class="sidebar-toggle" id="sidebarToggle">
                    <i class="fas fa-bars"></i>
                </button>
                <h1 class="page-title">Yacht Bookings</h1>
            </div>
            
            <div class="navbar-right">
                <div class="search-box">
                    <input type="text" class="search-input" placeholder="Search...">
                    <button class="search-btn">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
                
                <button class="notification-bell">
                    <i class="fas fa-bell"></i>
                    <span class="notification-badge" id="notificationBadge">0</span>
                </button>
                
                <div class="user-dropdown">
                    <div class="user-info" onclick="toggleUserMenu()">
                        <div class="user-avatar" id="userAvatar">A</div>
                        <div class="user-details">
                            <p class="user-name" id="userName">Admin User</p>
                            <p class="user-role" id="userRole">Administrator</p>
                        </div>
                        <i class="fas fa-chevron-down ms-2"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bookings Content -->
        <div class="dashboard-content">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>Yacht Bookings</h2>
                <div>
                    <button class="btn btn-outline-primary btn-sm me-2" onclick="toggleBookingFilters()">
                        <i class="fas fa-filter"></i> Filter
                    </button>
                    <button class="btn btn-primary btn-sm" onclick="refreshBookings()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
            </div>
            
            <!-- Booking Filters (initially hidden) -->
            <div class="table-card mb-3" id="bookingFilters" style="display: none;">
                <div class="row g-3">
                    <div class="col-md-2">
                        <label class="form-label">Status</label>
                        <select class="form-select" id="bookingStatusFilter">
                            <option value="">All Status</option>
                            <option value="new">New</option>
                            <option value="confirmed">Confirmed</option>
                            <option value="completed">Completed</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Search</label>
                        <input type="text" class="form-control" id="bookingSearchFilter" placeholder="Name, email, or phone...">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">From Date</label>
                        <input type="date" class="form-control" id="bookingDateFromFilter">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">To Date</label>
                        <input type="date" class="form-control" id="bookingDateToFilter">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Yacht</label>
                        <select class="form-select" id="bookingYachtFilter">
                            <option value="">All Yachts</option>
                            <option value="BLACK PEARL 95">BLACK PEARL 95</option>
                        </select>
                    </div>
                    <div class="col-md-1">
                        <label class="form-label">&nbsp;</label>
                        <button class="btn btn-primary w-100" onclick="applyBookingFilters()">
                            <i class="fas fa-filter"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="table-card">
                <div class="table-header d-flex justify-content-between align-items-center">
                    <h3 class="table-title mb-0">Yacht Bookings</h3>
                    <div id="bookingsPagination"></div>
                </div>
                <div class="table-responsive">
                    <div id="bookingsTableContainer">
                        <div class="loading">
                            <div class="spinner"></div>
                            <p>Loading bookings...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Booking Details Modal -->
    <div class="modal fade" id="bookingModal" tabindex="-1" aria-labelledby="bookingModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title" id="bookingModalLabel">
                        <i class="fas fa-anchor me-2"></i>
                        Booking Details
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="bookingModalBody">
                    <div class="text-center">
                        <div class="spinner-border text-success" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
                <div class="modal-footer" style="display: none;" id="bookingModalFooter">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="admin-common.js"></script>
    <script>

        /**
 * Bookings Page - Booking management functionality
 */

class BookingsPage extends AdminBase {
    constructor() {
        super();
        this.currentPage = 1;
        this.loadBookings();
    }

    async loadBookings() {
        this.currentPage = 1;
        await this.fetchBookings();
    }

    async fetchBookings(page = 1) {
        try {
            const params = new URLSearchParams({
                action: 'list',
                page: page,
                limit: 20
            });

            // Add filters if they exist
            const statusFilter = document.getElementById('bookingStatusFilter');
            const searchFilter = document.getElementById('bookingSearchFilter');
            const dateFromFilter = document.getElementById('bookingDateFromFilter');
            const dateToFilter = document.getElementById('bookingDateToFilter');
            const yachtFilter = document.getElementById('bookingYachtFilter');

            if (statusFilter && statusFilter.value) params.append('status', statusFilter.value);
            if (searchFilter && searchFilter.value) params.append('search', searchFilter.value);
            if (dateFromFilter && dateFromFilter.value) params.append('date_from', dateFromFilter.value);
            if (dateToFilter && dateToFilter.value) params.append('date_to', dateToFilter.value);
            if (yachtFilter && yachtFilter.value) params.append('yacht_name', yachtFilter.value);

            const data = await this.apiRequest(`../api/v1/bookingData.php?${params}`);
            
            if (data.success) {
                this.renderBookingsTable(data.data, data.pagination);
            } else {
                this.showError('Failed to load bookings: ' + data.message);
            }
        } catch (error) {
            console.error('Error fetching bookings:', error);
            this.showError('Network error occurred while loading bookings');
        }
    }

    renderBookingsTable(bookings, pagination) {
        const container = document.getElementById('bookingsTableContainer');
        
        if (!bookings || bookings.length === 0) {
            container.innerHTML = '<p class="text-muted text-center p-4">No bookings found</p>';
            return;
        }

        container.innerHTML = `
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Customer</th>
                        <th>Yacht</th>
                        <th>Date & Time</th>
                        <th>Charter Length</th>
                        <th>Price</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    ${bookings.map(booking => `
                        <tr>
                            <td>
                                <div>
                                    <strong>${booking.full_name}</strong><br>
                                    <small class="text-muted">
                                        <i class="fas fa-envelope me-1"></i>${booking.email}<br>
                                        <i class="fas fa-phone me-1"></i>${booking.phone}
                                    </small>
                                </div>
                            </td>
                            <td>
                                <span class="badge bg-info">${booking.yacht_name}</span>
                            </td>
                            <td>
                                <div>
                                    <strong>${booking.preferred_date_formatted}</strong><br>
                                    <small class="text-muted">${booking.preferred_time_formatted}</small>
                                </div>
                            </td>
                            <td>
                                <span class="badge bg-secondary">${booking.charter_length}</span>
                            </td>
                            <td>
                                <strong class="text-success">${booking.formatted_price}</strong>
                            </td>
                            <td>
                                <select class="form-select form-select-sm" 
                                        onchange="adminBase.updateBookingStatus(${booking.id}, this.value)"
                                        style="min-width: 120px;">
                                    <option value="new" ${booking.status === 'new' ? 'selected' : ''}>New</option>
                                    <option value="confirmed" ${booking.status === 'confirmed' ? 'selected' : ''}>Confirmed</option>
                                    <option value="completed" ${booking.status === 'completed' ? 'selected' : ''}>Completed</option>
                                    <option value="cancelled" ${booking.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                                </select>
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-primary" 
                                            onclick="adminBase.viewBookingDetails(${booking.id})"
                                            title="View Details">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn btn-outline-danger" 
                                            onclick="adminBase.deleteBooking(${booking.id})"
                                            title="Delete">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;

        // Render pagination
        this.renderBookingsPagination(pagination);
    }

    renderBookingsPagination(pagination) {
        const container = document.getElementById('bookingsPagination');
        if (!pagination || pagination.total_pages <= 1) {
            container.innerHTML = '';
            return;
        }

        const currentPage = pagination.current_page;
        const totalPages = pagination.total_pages;
        
        let paginationHTML = '<nav><ul class="pagination pagination-sm mb-0">';
        
        // Previous button
        if (pagination.has_prev) {
            paginationHTML += `<li class="page-item">
                <a class="page-link" href="#" onclick="adminBase.fetchBookings(${currentPage - 1})">Previous</a>
            </li>`;
        }
        
        // Page numbers
        const startPage = Math.max(1, currentPage - 2);
        const endPage = Math.min(totalPages, currentPage + 2);
        
        for (let i = startPage; i <= endPage; i++) {
            paginationHTML += `<li class="page-item ${i === currentPage ? 'active' : ''}">
                <a class="page-link" href="#" onclick="adminBase.fetchBookings(${i})">${i}</a>
            </li>`;
        }
        
        // Next button
        if (pagination.has_next) {
            paginationHTML += `<li class="page-item">
                <a class="page-link" href="#" onclick="adminBase.fetchBookings(${currentPage + 1})">Next</a>
            </li>`;
        }
        
        paginationHTML += '</ul></nav>';
        container.innerHTML = paginationHTML;
    }

    async updateBookingStatus(bookingId, newStatus) {
        try {
            const formData = new FormData();
            formData.append('booking_id', bookingId);
            formData.append('status', newStatus);

            const data = await this.apiRequest('../api/v1/bookingData.php', {
                method: 'POST',
                body: formData,
                headers: {
                    'Authorization': 'Bearer ' + this.adminToken
                }
            });

            if (data.success) {
                this.showSuccess('Booking status updated successfully');
                this.loadBadges(); // Refresh badges
            } else {
                this.showError('Failed to update booking status: ' + data.message);
                this.refreshBookings();
            }
        } catch (error) {
            console.error('Error updating booking status:', error);
            this.showError('Network error occurred');
            this.refreshBookings();
        }
    }

    async deleteBooking(bookingId) {
        if (!confirm('Are you sure you want to delete this booking? This action cannot be undone.')) {
            return;
        }

        try {
            const formData = new FormData();
            formData.append('booking_id', bookingId);

            const data = await this.apiRequest('../api/v1/bookingData.php?action=delete', {
                method: 'POST',
                body: formData,
                headers: {
                    'Authorization': 'Bearer ' + this.adminToken
                }
            });

            if (data.success) {
                this.showSuccess('Booking deleted successfully');
                this.refreshBookings();
                this.loadBadges(); // Refresh badges
            } else {
                this.showError('Failed to delete booking: ' + data.message);
            }
        } catch (error) {
            console.error('Error deleting booking:', error);
            this.showError('Network error occurred');
        }
    }

    async viewBookingDetails(bookingId) {
        try {
            // Show the modal with loading state
            const modal = new bootstrap.Modal(document.getElementById('bookingModal'));
            modal.show();
            
            // Reset modal content to loading state
            document.getElementById('bookingModalBody').innerHTML = `
                <div class="text-center">
                    <div class="spinner-border text-success" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2 text-muted">Loading booking details...</p>
                </div>
            `;
            
            // Fetch booking details
            const data = await this.apiRequest(`../api/v1/bookingData.php?action=list&search=&limit=1000`);
            
            if (data.success) {
                const booking = data.data.find(b => b.id === bookingId);
                if (booking) {
                    this.displayBookingModal(booking);
                } else {
                    throw new Error('Booking not found');
                }
            } else {
                throw new Error(data.message || 'Failed to fetch booking details');
            }
        } catch (error) {
            console.error('Error fetching booking details:', error);
            document.getElementById('bookingModalBody').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Error loading booking details: ${error.message}
                </div>
            `;
        }
    }

    displayBookingModal(booking) {
        const modalBody = document.getElementById('bookingModalBody');
        const modalFooter = document.getElementById('bookingModalFooter');
        
        modalBody.innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <div class="card border-0 bg-light h-100">
                        <div class="card-header bg-success text-white">
                            <h6 class="mb-0">
                                <i class="fas fa-user me-2"></i>
                                Customer Information
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label fw-bold text-muted">Full Name</label>
                                <p class="mb-0">${booking.full_name}</p>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold text-muted">Email Address</label>
                                <p class="mb-0">
                                    <a href="mailto:${booking.email}" class="text-decoration-none">
                                        <i class="fas fa-envelope me-1"></i>
                                        ${booking.email}
                                    </a>
                                </p>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold text-muted">Phone Number</label>
                                <p class="mb-0">
                                    <a href="tel:${booking.phone}" class="text-decoration-none">
                                        <i class="fas fa-phone me-1"></i>
                                        ${booking.phone}
                                    </a>
                                </p>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold text-muted">Submission Date</label>
                                <p class="mb-0">
                                    <i class="fas fa-calendar me-1"></i>
                                    ${booking.submitted_date} at ${booking.submitted_time}
                                </p>
                            </div>
                            <div class="mb-0">
                                <label class="form-label fw-bold text-muted">IP Address</label>
                                <p class="mb-0 small text-muted">${booking.ip_address}</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card border-0 bg-light h-100">
                        <div class="card-header bg-info text-white">
                            <h6 class="mb-0">
                                <i class="fas fa-anchor me-2"></i>
                                Booking Details
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label fw-bold text-muted">Yacht</label>
                                <p class="mb-0">
                                    <span class="badge bg-info fs-6">${booking.yacht_name}</span>
                                </p>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold text-muted">Preferred Date</label>
                                <p class="mb-0">
                                    <i class="fas fa-calendar-alt me-1"></i>
                                    ${booking.preferred_date_formatted}
                                </p>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold text-muted">Preferred Time</label>
                                <p class="mb-0">
                                    <i class="fas fa-clock me-1"></i>
                                    ${booking.preferred_time_formatted}
                                </p>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold text-muted">Charter Length</label>
                                <p class="mb-0">
                                    <span class="badge bg-secondary fs-6">${booking.charter_length}</span>
                                </p>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold text-muted">Total Price</label>
                                <p class="mb-0">
                                    <strong class="text-success fs-5">${booking.formatted_price}</strong>
                                </p>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold text-muted">Status</label>
                                <div>
                                    <span class="badge bg-${this.getBookingStatusColor(booking.status)} fs-6">
                                        ${booking.status.charAt(0).toUpperCase() + booking.status.slice(1)}
                                    </span>
                                </div>
                            </div>
                            ${booking.notes ? `
                                <div class="mb-0">
                                    <label class="form-label fw-bold text-muted">Notes</label>
                                    <div class="p-2 bg-white rounded border">
                                        <small>${booking.notes}</small>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-12">
                    <div class="card border-0 bg-light">
                        <div class="card-header bg-warning text-dark">
                            <h6 class="mb-0">
                                <i class="fas fa-tools me-2"></i>
                                Quick Actions
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row g-2">
                                <div class="col-md-3">
                                    <button class="btn btn-outline-success w-100 btn-sm" onclick="adminBase.updateBookingStatusInModal(${booking.id}, 'confirmed')">
                                        <i class="fas fa-check me-1"></i>
                                        Confirm
                                    </button>
                                </div>
                                <div class="col-md-3">
                                    <button class="btn btn-outline-primary w-100 btn-sm" onclick="adminBase.updateBookingStatusInModal(${booking.id}, 'completed')">
                                        <i class="fas fa-check-double me-1"></i>
                                        Complete
                                    </button>
                                </div>
                                <div class="col-md-3">
                                    <button class="btn btn-outline-danger w-100 btn-sm" onclick="adminBase.updateBookingStatusInModal(${booking.id}, 'cancelled')">
                                        <i class="fas fa-times me-1"></i>
                                        Cancel
                                    </button>
                                </div>
                                <div class="col-md-3">
                                    <button class="btn btn-outline-info w-100 btn-sm" onclick="window.open('mailto:${booking.email}?subject=Your Yacht Booking - ${booking.yacht_name}&body=Hello ${booking.full_name},\\n\\nThank you for your yacht booking...', '_blank')">
                                        <i class="fas fa-envelope me-1"></i>
                                        Email
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Hide footer
        modalFooter.style.display = 'none';
    }

    getBookingStatusColor(status) {
        const colors = {
            'new': 'primary',
            'confirmed': 'success',
            'completed': 'info',
            'cancelled': 'danger'
        };
        return colors[status] || 'secondary';
    }

    async updateBookingStatusInModal(bookingId, newStatus) {
        try {
            const formData = new FormData();
            formData.append('booking_id', bookingId);
            formData.append('status', newStatus);

            const data = await this.apiRequest('../api/v1/bookingData.php', {
                method: 'POST',
                body: formData,
                headers: {
                    'Authorization': 'Bearer ' + this.adminToken
                }
            });

            if (data.success) {
                this.showSuccess('Booking status updated successfully');
                // Close modal and refresh the bookings list
                bootstrap.Modal.getInstance(document.getElementById('bookingModal')).hide();
                this.refreshBookings();
                this.loadBadges(); // Refresh badges
            } else {
                this.showError('Failed to update booking status: ' + data.message);
            }
        } catch (error) {
            console.error('Error updating booking status:', error);
            this.showError('Network error occurred');
        }
    }

    refreshBookings() {
        this.fetchBookings(this.currentPage || 1);
    }
}

// Global functions for HTML onclick events
function toggleBookingFilters() {
    const filtersDiv = document.getElementById('bookingFilters');
    if (filtersDiv.style.display === 'none') {
        filtersDiv.style.display = 'block';
    } else {
        filtersDiv.style.display = 'none';
    }
}

function applyBookingFilters() {
    adminBase.currentPage = 1;
    adminBase.fetchBookings(1);
}

function refreshBookings() {
    adminBase.refreshBookings();
}

// Initialize bookings page
document.addEventListener('DOMContentLoaded', function() {
    adminBase = new BookingsPage();
});


    </script>
</body>
</html>

