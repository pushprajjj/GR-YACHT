<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Contact Page - GR Yachts Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="admin-styles.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        .hero-preview img {
            max-height: 200px;
            object-fit: cover;
            border-radius: 8px;
        }
        
        .contact-section-card {
            margin-bottom: 20px;
        }
        
        .section-preview {
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-top: 15px;
        }
        
        .map-preview {
            width: 100%;
            height: 200px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            background: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <img src="../assets/images/logoColoured.png" alt="GR Yachts" class="sidebar-logo">
            <h3 class="sidebar-title">GR YACHTS</h3>
            <p class="sidebar-subtitle">Admin Dashboard</p>
        </div>
        
        <nav class="sidebar-nav">
            <div class="nav-item">
                <a href="dashboard.html" class="nav-link">
                    <i class="fas fa-tachometer-alt"></i>
                    Dashboard
                </a>
            </div>
            <div class="nav-item">
                <a href="contacts.html" class="nav-link">
                    <i class="fas fa-envelope"></i>
                    Contact Messages
                    <span class="nav-badge" id="contactsBadge">0</span>
                </a>
            </div>
            <div class="nav-item">
                <a href="bookings.html" class="nav-link">
                    <i class="fas fa-anchor"></i>
                    Yacht Bookings
                    <span class="nav-badge" id="bookingsBadge">0</span>
                </a>
            </div>
            <div class="nav-item">
                <a href="yacht-fleet.html" class="nav-link">
                    <i class="fas fa-ship"></i>
                    Yacht Fleet
                </a>
            </div>
            <div class="nav-item">
                <a href="manage-site.html" class="nav-link active">
                    <i class="fas fa-edit"></i>
                    Manage Site
                </a>
            </div>
            <div class="nav-item">
                <a href="settings.html" class="nav-link">
                    <i class="fas fa-cog"></i>
                    Settings
                </a>
            </div>
            <div class="nav-item">
                <a href="#" class="nav-link" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                    Logout
                </a>
            </div>
        </nav>
    </div>

    <!-- Sidebar Overlay for Mobile -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- Main Content -->
    <div class="main-content" id="mainContent">
        <!-- Top Navbar -->
        <div class="top-navbar">
            <div class="navbar-left">
                <button class="sidebar-toggle" id="sidebarToggle">
                    <i class="fas fa-bars"></i>
                </button>
                <h1 class="page-title">Edit Contact Page</h1>
            </div>
            
            <div class="navbar-right">
                <div class="search-box">
                    <input type="text" class="search-input" placeholder="Search...">
                    <button class="search-btn">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
                
                <button class="notification-bell">
                    <i class="fas fa-bell"></i>
                    <span class="notification-badge" id="notificationBadge">0</span>
                </button>
                
                <div class="user-dropdown">
                    <div class="user-info" onclick="toggleUserMenu()">
                        <div class="user-avatar" id="userAvatar">A</div>
                        <div class="user-details">
                            <p class="user-name" id="userName">Admin User</p>
                            <p class="user-role" id="userRole">Administrator</p>
                        </div>
                        <i class="fas fa-chevron-down ms-2"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Edit Contact Page Content -->
        <div class="dashboard-content">
            <div class="row">
                <div class="col-12">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2>Edit Contact Page Content</h2>
                        <div>
                            <button type="button" class="btn btn-secondary me-2" onclick="window.location.href='manage-site.html'">
                                <i class="fas fa-arrow-left me-2"></i>Back to Manage Site
                            </button>
                        </div>
                    </div>
                    
                    <div class="alert alert-info mb-4">
                        <i class="fas fa-info-circle me-2"></i>
                        Edit the content that appears on your website's contact page. Changes will be reflected immediately after saving.
                    </div>
                </div>
            </div>

            <form id="contactPageForm">
                <!-- Contact Hero Section -->
                <div class="table-card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h4 class="mb-0">
                            <i class="fas fa-star me-2"></i>Hero Section
                        </h4>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="heroTitle" class="form-label">Hero Title (Line 1)</label>
                                    <input type="text" class="form-control" id="heroTitle" name="heroTitle" placeholder="Enter hero title line 1" required>
                                </div>
                                <div class="mb-3">
                                    <label for="heroSubtitle" class="form-label">Hero Title (Line 2)</label>
                                    <input type="text" class="form-control" id="heroSubtitle" name="heroSubtitle" placeholder="Enter hero title line 2" required>
                                </div>
                                <div class="mb-3">
                                    <label for="heroButtonText" class="form-label">Button Text</label>
                                    <input type="text" class="form-control" id="heroButtonText" name="heroButtonText" placeholder="Enter button text" required>
                                </div>
                                <div class="mb-3">
                                    <label for="heroButtonLink" class="form-label">Button Link</label>
                                    <input type="text" class="form-control" id="heroButtonLink" name="heroButtonLink" placeholder="Enter button link" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="contactHeroImage" class="form-label">Hero Background Image</label>
                                    <input type="file" class="form-control" id="contactHeroImage" name="heroImage" accept="image/*" onchange="previewImage(this)">
                                    <div class="form-text">Upload a new hero background image (optional)</div>
                                </div>
                                <div class="hero-preview mt-3">
                                    <img src="../assets/images/heroSectionbg.jpg" id="imagePreview" alt="Contact Hero" class="img-fluid rounded" style="max-height: 200px;" onerror="this.src='../assets/images/heroSectionbg.jpg'">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Contact Info Section -->
                <div class="table-card mb-4">
                    <div class="card-header bg-success text-white">
                        <h4 class="mb-0">
                            <i class="fas fa-info-circle me-2"></i>Contact Info Section
                        </h4>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="contactInfoTitle" class="form-label">Contact Info Title</label>
                                    <input type="text" class="form-control" id="contactInfoTitle" name="contactInfoTitle" placeholder="Enter contact info title" required>
                                </div>
                                <div class="mb-3">
                                    <label for="whatsappNumber" class="form-label">WhatsApp Number</label>
                                    <input type="text" class="form-control" id="whatsappNumber" name="whatsappNumber" placeholder="Enter WhatsApp number with country code" required>
                                    <div class="form-text">Include country code (e.g., +971 58 186 2811)</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="section-preview">
                                    <i class="fab fa-whatsapp text-success fs-1 mb-2"></i>
                                    <p class="mb-0">WhatsApp contact section preview</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Contact Form Section -->
                <div class="table-card mb-4">
                    <div class="card-header bg-warning text-dark">
                        <h4 class="mb-0">
                            <i class="fas fa-envelope me-2"></i>Contact Form Section
                        </h4>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="formSubtitle" class="form-label">Form Subtitle</label>
                                    <input type="text" class="form-control" id="formSubtitle" name="formSubtitle" placeholder="Enter form subtitle" required>
                                </div>
                                <div class="mb-3">
                                    <label for="formTitle" class="form-label">Form Title</label>
                                    <input type="text" class="form-control" id="formTitle" name="formTitle" placeholder="Enter form title" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="section-preview">
                                    <i class="fas fa-paper-plane text-primary fs-1 mb-2"></i>
                                    <p class="mb-0">Contact form section preview</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Location Info Section -->
                <div class="table-card mb-4">
                    <div class="card-header bg-info text-white">
                        <h4 class="mb-0">
                            <i class="fas fa-map-marker-alt me-2"></i>Location Info Section
                        </h4>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="locationTitle" class="form-label">Location Title</label>
                                    <input type="text" class="form-control" id="locationTitle" name="locationTitle" placeholder="Enter location title" required>
                                </div>
                                <div class="mb-3">
                                    <label for="address" class="form-label">Address</label>
                                    <textarea class="form-control" id="address" name="address" rows="2" placeholder="Enter full address" required></textarea>
                                </div>
                                <div class="mb-3">
                                    <label for="locationWhatsapp" class="form-label">WhatsApp Number</label>
                                    <input type="text" class="form-control" id="locationWhatsapp" name="locationWhatsapp" placeholder="Enter WhatsApp number" required>
                                </div>
                                <div class="mb-3">
                                    <label for="email" class="form-label">Email Address</label>
                                    <input type="email" class="form-control" id="email" name="email" placeholder="Enter email address" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="section-preview">
                                    <div class="row text-center">
                                        <div class="col-4">
                                            <i class="fas fa-map-marker-alt text-danger fs-3"></i>
                                            <p class="small mb-0">Location</p>
                                        </div>
                                        <div class="col-4">
                                            <i class="fab fa-whatsapp text-success fs-3"></i>
                                            <p class="small mb-0">WhatsApp</p>
                                        </div>
                                        <div class="col-4">
                                            <i class="fas fa-envelope text-primary fs-3"></i>
                                            <p class="small mb-0">Email</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Map Section -->
                <div class="table-card mb-4">
                    <div class="card-header bg-secondary text-white">
                        <h4 class="mb-0">
                            <i class="fas fa-globe me-2"></i>Google Map Section
                        </h4>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="mapIframe" class="form-label">Google Map Embed Code</label>
                                    <div class="input-group">
                                        <textarea class="form-control" id="mapIframe" name="mapIframe" rows="5" placeholder="Paste complete Google Maps iframe code here" required></textarea>
                                        <button class="btn btn-outline-secondary" type="button" id="testMapBtn" onclick="testMapUrl()" title="Test Map">
                                            <i class="fas fa-external-link-alt"></i> Test
                                        </button>
                                    </div>
                                    <div class="form-text">
                                        <strong>How to get Google Maps embed code:</strong>
                                        <ol class="small mt-2 mb-2">
                                            <li>Go to <a href="https://maps.google.com" target="_blank">Google Maps</a></li>
                                            <li>Search for your location</li>
                                            <li>Click "Share" → "Embed a map"</li>
                                            <li>Copy the <strong>complete iframe code</strong> and paste it here</li>
                                        </ol>
                                        <div class="alert alert-success small mt-2 mb-0">
                                            <i class="fas fa-magic me-1"></i>
                                            <strong>Just paste the complete code!</strong> The system will automatically handle dimensions and styling.
                                        </div>
                                        <div class="alert alert-info small mt-2 mb-0">
                                            <i class="fas fa-info-circle me-1"></i>
                                            <strong>Example:</strong> &lt;iframe src="https://www.google.com/maps/embed?pb=..." width="600" height="450"&gt;&lt;/iframe&gt;
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="map-preview" id="mapPreview">
                                    <i class="fas fa-map fs-1 mb-2"></i>
                                    <p class="mb-0">Map preview will appear here</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Save Button -->
                <div class="text-center mb-4">
                    <button type="submit" class="btn btn-success btn-lg">
                        <i class="fas fa-save me-2"></i>Save All Changes
                    </button>
                    <button type="button" class="btn btn-secondary btn-lg ms-3" onclick="resetForm()">
                        <i class="fas fa-undo me-2"></i>Reset Form
                    </button>
                </div>
            </form>

        </div>
    </div>

    <!-- Loading Modal -->
    <div class="modal fade" id="loadingModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-sm modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body text-center p-4">
                    <div class="spinner-border text-primary mb-3" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mb-0">Saving changes...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="admin-common.js"></script>

    <script>
        /**
         * Contact Page Editor - Content management functionality
         */

        class ContactPageEditor extends AdminBase {
            constructor() {
                super();
                this.loadContactPage();
            }

            loadContactPage() {
                console.log('Contact Page editor loaded');
                this.setupContentManagement();
            }

            setupContentManagement() {
                // Initialize contact page functionality
                this.fetchContactPageData();
                this.setupMapPreview();
            }

            async fetchContactPageData() {
                try {
                    const response = await fetch('../api/v1/contactPageHandler.php?action=getContactContent');
                    const data = await response.json();
                    
                    if (data.success && data.data) {
                        this.populateForm(data.data);
                    }
                } catch (error) {
                    console.error('Error fetching contact page data:', error);
                }
            }

            populateForm(data) {
                // Populate hero section
                if (data.hero) {
                    document.getElementById('heroTitle').value = data.hero.title || '';
                    document.getElementById('heroSubtitle').value = data.hero.subtitle || '';
                    document.getElementById('heroButtonText').value = data.hero.button_text || '';
                    document.getElementById('heroButtonLink').value = data.hero.button_link || '';
                    if (data.hero.image_path) {
                        document.getElementById('imagePreview').src = `../api/uploads/contact/${data.hero.image_path}`;
                    }
                }

                // Populate contact info section
                if (data.contact_info) {
                    document.getElementById('contactInfoTitle').value = data.contact_info.title || '';
                    document.getElementById('whatsappNumber').value = data.contact_info.whatsapp_number || '';
                }

                // Populate form section
                if (data.form_section) {
                    document.getElementById('formSubtitle').value = data.form_section.subtitle || '';
                    document.getElementById('formTitle').value = data.form_section.title || '';
                }

                // Populate location info section
                if (data.location_info) {
                    document.getElementById('locationTitle').value = data.location_info.title || '';
                    document.getElementById('address').value = data.location_info.address || '';
                    document.getElementById('locationWhatsapp').value = data.location_info.whatsapp_number || '';
                    document.getElementById('email').value = data.location_info.email || '';
                }

                // Populate map section
                if (data.map) {
                    document.getElementById('mapIframe').value = data.map.map_iframe || '';
                    this.updateMapPreview(data.map.map_iframe);
                }
            }

            setupMapPreview() {
                const mapIframeInput = document.getElementById('mapIframe');
                mapIframeInput.addEventListener('input', () => {
                    const input = mapIframeInput.value.trim();
                    this.validateMapInput(input);
                    this.updateMapPreview(input);
                });
            }

            validateMapInput(input) {
                const mapIframeInput = document.getElementById('mapIframe');
                
                // Remove any existing validation classes
                mapIframeInput.classList.remove('is-valid', 'is-invalid');
                
                if (!input) {
                    return; // Empty is okay
                }
                
                // Check if it's a complete iframe code or just a URL
                const isIframeCode = input.trim().toLowerCase().includes('<iframe');
                const isValidGoogleMapsEmbed = input.includes('google.com/maps/embed');
                
                if (isValidGoogleMapsEmbed) {
                    mapIframeInput.classList.add('is-valid');
                } else {
                    mapIframeInput.classList.add('is-invalid');
                    
                    // Show helpful feedback
                    let feedback = mapIframeInput.nextElementSibling;
                    if (!feedback || !feedback.classList.contains('invalid-feedback')) {
                        feedback = document.createElement('div');
                        feedback.className = 'invalid-feedback';
                        mapIframeInput.parentNode.insertBefore(feedback, mapIframeInput.nextElementSibling);
                    }
                    
                    if (input.includes('google.com/maps') && !input.includes('/embed')) {
                        feedback.textContent = 'Please use the embed code (Share → Embed a map), not the regular Google Maps URL.';
                    } else if (isIframeCode && !input.includes('google.com/maps')) {
                        feedback.textContent = 'Please use Google Maps iframe code.';
                    } else {
                        feedback.textContent = 'Please enter a valid Google Maps embed code or URL.';
                    }
                }
            }

            updateMapPreview(iframeCode) {
                const mapPreview = document.getElementById('mapPreview');
                if (iframeCode && iframeCode.trim()) {
                    // Show loading state first
                    mapPreview.innerHTML = `
                        <div class="d-flex flex-column align-items-center justify-content-center" style="height: 200px;">
                            <div class="spinner-border text-primary mb-2" role="status">
                                <span class="visually-hidden">Loading map...</span>
                            </div>
                            <p class="mb-0 text-muted">Loading map preview...</p>
                        </div>
                    `;
                    
                    // Create preview with error handling
                    setTimeout(() => {
                        try {
                            // Create a container div for the iframe
                            const previewContainer = document.createElement('div');
                            previewContainer.style.width = '100%';
                            previewContainer.style.height = '200px';
                            previewContainer.style.borderRadius = '8px';
                            previewContainer.style.overflow = 'hidden';
                            previewContainer.style.border = '1px solid #dee2e6';
                            
                            // Insert the iframe code directly, but modify dimensions for preview
                            let modifiedIframeCode = iframeCode;
                            
                            // Replace width and height attributes for preview
                            modifiedIframeCode = modifiedIframeCode.replace(/width=["'][^"']*["']/gi, 'width="100%"');
                            modifiedIframeCode = modifiedIframeCode.replace(/height=["'][^"']*["']/gi, 'height="200"');
                            
                            // If no width/height specified, add them
                            if (!modifiedIframeCode.includes('width=')) {
                                modifiedIframeCode = modifiedIframeCode.replace('<iframe', '<iframe width="100%"');
                            }
                            if (!modifiedIframeCode.includes('height=')) {
                                modifiedIframeCode = modifiedIframeCode.replace('<iframe', '<iframe height="200"');
                            }
                            
                            // Add border radius style
                            if (modifiedIframeCode.includes('style=')) {
                                modifiedIframeCode = modifiedIframeCode.replace(/style=["']([^"']*)["']/gi, 'style="$1; border-radius: 8px;"');
                            } else {
                                modifiedIframeCode = modifiedIframeCode.replace('<iframe', '<iframe style="border-radius: 8px;"');
                            }
                            
                            previewContainer.innerHTML = modifiedIframeCode;
                            
                            // Clear loading and show preview
                            mapPreview.innerHTML = '';
                            mapPreview.appendChild(previewContainer);
                            
                            console.log('Map iframe preview loaded');
                            
                        } catch (error) {
                            console.error('Failed to load map iframe preview:', error);
                            mapPreview.innerHTML = `
                                <div class="alert alert-warning mb-0" style="height: 200px; display: flex; align-items: center; justify-content: center;">
                                    <div class="text-center">
                                        <i class="fas fa-exclamation-triangle fs-2 mb-2"></i>
                                        <p class="mb-1"><strong>Map Preview Error</strong></p>
                                        <p class="mb-0 small">Invalid iframe code, but it will be saved</p>
                                    </div>
                                </div>
                            `;
                        }
                    }, 500);
                } else {
                    mapPreview.innerHTML = `
                        <div class="d-flex flex-column align-items-center justify-content-center" style="height: 200px; background-color: #f8f9fa; border-radius: 8px;">
                            <i class="fas fa-map fs-1 mb-2 text-muted"></i>
                            <p class="mb-0 text-muted">Map preview will appear here</p>
                            <small class="text-muted mt-1">Paste complete iframe code above</small>
                        </div>
                    `;
                }
            }
        }

        // Handle contact page form submission
        function saveContactPageContent(event) {
            event.preventDefault();
            
            const form = document.getElementById('contactPageForm');
            const formData = new FormData(form);
            formData.append('action', 'updateContactContent');
            
            Swal.fire({
                title: 'Saving changes...',
                didOpen: () => {
                    Swal.showLoading();
                },
                allowOutsideClick: false,
                allowEscapeKey: false,
                showConfirmButton: false
            });
            
            fetch('../api/v1/contactPageHandler.php', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Success!',
                        text: 'Contact page updated successfully!',
                        timer: 2000,
                        showConfirmButton: false
                    });
                } else {
                    throw new Error(data.message || 'Unknown error occurred');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Oops...',
                    text: 'An error occurred while updating the contact page',
                    confirmButtonColor: '#3085d6'
                });
            });
        }

        // Image preview function
        function previewImage(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('imagePreview').src = e.target.result;
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        // Form event listener
        document.getElementById('contactPageForm').addEventListener('submit', function(event) {
            saveContactPageContent(event);
        });

        // Reset form function
        function resetForm() {
            Swal.fire({
                title: 'Are you sure?',
                text: "This will reset all your changes!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Yes, reset it!'
            }).then((result) => {
                if (result.isConfirmed) {
                    document.getElementById('contactPageForm').reset();
                    document.getElementById('imagePreview').src = '../assets/images/heroSectionbg.jpg';
                    document.getElementById('mapPreview').innerHTML = `
                        <i class="fas fa-map fs-1 mb-2"></i>
                        <p class="mb-0">Map preview will appear here</p>
                    `;
                    Swal.fire({
                        icon: 'success',
                        title: 'Reset Complete!',
                        text: 'The form has been reset to default values.',
                        timer: 1500,
                        showConfirmButton: false
                    });
                }
            });
        }

        // Test map function
        function testMapUrl() {
            const mapInput = document.getElementById('mapIframe').value.trim();
            const testBtn = document.getElementById('testMapBtn');
            
            if (!mapInput) {
                Swal.fire({
                    icon: 'warning',
                    title: 'No map code to test',
                    text: 'Please enter Google Maps iframe code first.',
                    confirmButtonColor: '#3085d6'
                });
                return;
            }
            
            // Disable button temporarily
            const originalHTML = testBtn.innerHTML;
            testBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Testing...';
            testBtn.disabled = true;
            
            try {
                let testUrl = '';
                
                // Check if it's iframe code or just URL
                if (mapInput.toLowerCase().includes('<iframe')) {
                    // Extract URL from iframe code
                    const srcMatch = mapInput.match(/src=["']([^"']+)["']/i);
                    if (srcMatch && srcMatch[1]) {
                        testUrl = srcMatch[1];
                        // Decode HTML entities if present
                        const textarea = document.createElement('textarea');
                        textarea.innerHTML = testUrl;
                        testUrl = textarea.value;
                    }
                } else {
                    // It's already a URL
                    testUrl = mapInput;
                }
                
                if (!testUrl) {
                    throw new Error('Could not extract URL from iframe code');
                }
                
                // Test by opening in new window
                const testWindow = window.open(testUrl, '_blank', 'width=800,height=600,scrollbars=yes,resizable=yes');
                
                setTimeout(() => {
                    testBtn.innerHTML = originalHTML;
                    testBtn.disabled = false;
                    
                    if (testWindow) {
                        Swal.fire({
                            icon: 'success',
                            title: 'Map Test Successful',
                            text: 'Map opened in new tab. If it loads correctly, your iframe code is valid!',
                            confirmButtonColor: '#3085d6'
                        });
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Popup Blocked',
                            text: 'Please allow popups and try again, or manually test the map in a new browser tab.',
                            confirmButtonColor: '#3085d6'
                        });
                    }
                }, 1000);
                
            } catch (error) {
                testBtn.innerHTML = originalHTML;
                testBtn.disabled = false;
                
                Swal.fire({
                    icon: 'error',
                    title: 'Invalid Map Code',
                    text: 'The iframe code appears to be invalid. Please check and try again.',
                    confirmButtonColor: '#3085d6'
                });
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            new ContactPageEditor();
        });
    </script>
</body>
</html>
